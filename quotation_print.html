<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <title>Quotation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

    body {
      font-family: 'Roboto', sans-serif;
      background: #fff;
      font-size: 12px;
      position: relative;
      min-height: 297mm;
    }

    .bordered th,
    .bordered td {
      border: 1px solid #e2e8f0;
      padding: 4px 6px;
    }

    .total-row {
      background-color: #f8fafc;
    }

    .compact-table {
      font-size: 11px;
    }

    .compact-table th,
    .compact-table td {
      padding: 3px 4px;
    }

    .quotation-footer {
      position: absolute;
      bottom: 10mm;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 11px;
      padding-top: 10px;
      width: 210mm;
      margin: 0 auto;
    }

    @media print {
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
    }
  </style>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const script = document.createElement('script');
      script.src = `./assets/js/api.js?v=${new Date().getTime()}`;
      document.body.appendChild(script);
    });
  </script>
</head>

<body>
  <div id="invoiceContainer" class="w-[210mm] mx-auto p-[10mm] bg-white min-h-[277mm] relative pb-20"></div>

  <script>
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    const urlParams = new URLSearchParams(window.location.search);
    const pesanan_id = urlParams.get("id");
    const isDownload = urlParams.get("mode") === "download";
    const container = document.getElementById("invoiceContainer");

    const formatRp = val => `Rp ${(+val).toLocaleString("id-ID")}`;
    function finance(value) {
      return new Intl.NumberFormat("id-ID", {
        maximumFractionDigits: 0,
      }).format(value);
    }

    // Handle Enter menjadi baris baru
    function formatText(text) {
      if (!text) return "-";
      return text.replace(/(?:\r\n|\r|\n)/g, '<br>');
    }

    async function loadLogoWithAuth(url) {
      try {
        const res = await fetch(url, {
          headers: {
            "Authorization": `Bearer ${API_TOKEN}`
          }
        });
        if (!res.ok) throw new Error("Gagal load logo");

        const blob = await res.blob();
        const objectUrl = URL.createObjectURL(blob);

        const logoPreview = document.getElementById("logo_preview");
        logoPreview.src = objectUrl;
        logoPreview.classList.remove("hidden");
      } catch (err) {
        console.error("Error load logo:", err);
      }
    }

    function terbilang(n) {
      const satuan = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
      n = Math.floor(n);

      if (n < 12) return satuan[n];
      if (n < 20) return terbilang(n - 10) + " Belas";
      if (n < 100) return terbilang(Math.floor(n / 10)) + " Puluh " + terbilang(n % 10);
      if (n < 200) return "Seratus " + terbilang(n - 100);
      if (n < 1000) return terbilang(Math.floor(n / 100)) + " Ratus " + terbilang(n % 100);
      if (n < 2000) return "Seribu " + terbilang(n - 1000);
      if (n < 1000000) return terbilang(Math.floor(n / 1000)) + " Ribu " + terbilang(n % 1000);
      if (n < 1000000000) return terbilang(Math.floor(n / 1000000)) + " Juta " + terbilang(n % 1000000);
      if (n < 1000000000000) return terbilang(Math.floor(n / 1000000000)) + " Milyar " + terbilang(n % 1000000000);
      if (n < 1000000000000000) return terbilang(Math.floor(n / 1000000000000)) + " Triliun " + terbilang(n % 1000000000000);

      return "";
    }

    async function loadSubCategories() {
      try {
        const res = await fetch(`${baseUrl}/list/sub_category/1`, {
          headers: {
            Authorization: `Bearer ${API_TOKEN}`
          }
        });
        const result = await res.json();
        return result.listData || [];
      } catch (err) {
        console.error("Gagal memuat kategori", err);
        return [];
      }
    }

    async function loadPesananData() {
      try {
        const [subCategories, pesananRes] = await Promise.all([
          loadSubCategories(),
          fetch(`${baseUrl}/detail/sales/${pesanan_id}`, {
            headers: { Authorization: `Bearer ${API_TOKEN}` }
          })
        ]);

        const pesananResult = await pesananRes.json();
        const data = pesananResult?.detail;
        const salestype = parseInt(data.type_id);

        if (!data) throw new Error("Data pesanan tidak ditemukan");

        // Mapping sub_category
        const itemsWithCategory = data.items.map(item => {
          const category = subCategories.find(c => c.sub_category_id == item.sub_category_id);
          return {
            ...item,
            categoryName: category ? category.nama : 'Lainnya'
          };
        });

        // Grouping
        const groupedItems = itemsWithCategory.reduce((acc, item) => {
          if (!acc[item.categoryName]) acc[item.categoryName] = [];
          acc[item.categoryName].push(item);
          return acc;
        }, {});

        const showSpec = (salestype === 2 || salestype === 3);
        const isTurnkey = showSpec;

        // Build Table
        const tableRows = Object.entries(groupedItems).map(([category, items]) => {

          // PERUBAHAN DISINI:
          // Variabel counter kita taruh di DALAM loop kategori.
          // Sehingga setiap kategori baru, dia akan reset jadi 1 lagi.
          let categoryItemCounter = 1;

          // Header Kategori
          let headerHtml = `
              <tr class="bg-white">
                <td colspan="7" class="p-1 font-bold bg-gray-400 text-black text-xs border border-black">
                  ${category}
                </td>
              </tr>
           `;

          // Item Loop
          const itemsHtml = items.map(item => {

            // Mengambil angka counter lokal (per kategori)
            let rowNumberDisplay = categoryItemCounter++;

            return `
                <tr class="bg-material">
                  
                  <td class="text-center text-gray-800 border border-black align-top">
                    ${rowNumberDisplay}
                  </td>
                  
                  <td colspan="2" class="p-1 text-black border border-black">
                    <div class="text-xs text-black">
                          ${item.product || "-"}
                    </div>
                    ${item.description ? `<div class="text-xs text-black mt-1">
                      ${item.description.split(/\r?\n|-/).filter(line => line.trim() !== "").map((line, i) => `<div class="mb-1">- ${line.trim()}</div>`).join("")}
                    </div>` : ''}
                  </td>

                  ${(item.materials && item.materials.length > 0)
                ? `<td colspan="4" class="text-center border border-black"></td>`
                : `
                        <td class="text-center border border-black align-top">${item.qty}</td>
                        <td class="text-center border border-black align-top">${item.unit}</td>
                        <td class="border border-black align-top">
                          <div class="flex justify-between"><span>Rp</span><span>${finance(item.unit_price)}</span></div>
                        </td>
                        <td class="border border-black font-medium align-top">
                          <div class="flex justify-between"><span>Rp</span><span>${finance(item.total)}</span></div>
                        </td>
                      `
              }
                </tr>

                ${(item.materials || []).map((mat, matIndex) => {
                const hasSpec = mat.specification && mat.specification.trim() !== "" && mat.specification !== "-";

                // MENGEMBALIKAN PENOMORAN SUB ITEM (Contoh: 1.1, 1.2, dst)
                // Menggunakan rowNumberDisplay yang sudah ter-reset per kategori
                const subNumber = `${rowNumberDisplay}.${matIndex + 1}`;

                const formattedSpec = hasSpec ? mat.specification.replace(/(?:\r\n|\r|\n)/g, '<br>') : '';

                return `
                    <tr>
                      <td class="text-center text-gray-600 border border-black align-top text-[10px]">
                      </td> 
                      
                      <td colspan="2" class="border border-black align-top">
                         <div class="text-black">
                             ${subNumber} ${mat.name}
                         </div>
                         ${hasSpec ? `
                             <div class="text-xs text-black mt-1 ml-3">
                                ${formattedSpec}
                             </div>
                         ` : ''}
                      </td>

                      <td class="text-center border border-black align-top">${mat.qty}</td>
                      <td class="text-center border border-black align-top">${mat.unit}</td>
                      <td class="border border-black align-top">
                          <div class="flex justify-between"><span>Rp</span><span>${finance(mat.unit_price)}</span></div>
                      </td>
                      <td class="border border-black font-medium align-top">
                          <div class="flex justify-between"><span>Rp</span><span>${finance(mat.total)}</span></div>
                      </td>
                    </tr>
                  `}).join('')
              }
              `;
          }).join('');

          return headerHtml + itemsHtml;
        }).join('');

        const revisionInfo = data.revision_status && data.revision_number ? `${data.revision_status} (${data.revision_number})` : '-';
        const isWon = data.status_id == 2 || data.status_sales === "Won";
        const noValue = isWon ? (data.inv_number || data.no_qtn) : data.no_qtn;

        let signatureSection = "";
        if (isWon) {
          signatureSection = `
            <div class="text-sm text-right">
              <p>Jakarta, ${data.formatted_date}</p>
              <div class="mt-2"></div>
              <p class="mt-2 font-semibold">Nama PIC</p>
              <p>Jabatan PIC</p>
            </div>`;
        }

        let approvedSection = "";
        let footerSection = "";
        function encodeSign(invNumber) {
          let base = btoa(invNumber);
          return base.replace(/=/g, "").replace(/\+/g, "X").replace(/\//g, "9");
        }

        if (!isWon) {
          let signcode = 'https://digitalsign.dinastikelektrik.id/ref=' + (data.inv_number || data.no_qtn);
          let encodesign = encodeSign(signcode);
          approvedSection = `
                <div class="text-sm text-right mt-10">
                  <p class="font-semibold">APPROVED BY</p>
                  <div id="qrcode" class="mt-2 inline-block p-2 bg-white rounded shadow"></div>
                  <p class="mt-2 font-semibold">Rian Septiadi Saimima</p>
                  <p class="text-xs text-gray-500 mt-1">
                    This document is digitally signed: <span class="font-mono">${encodesign}</span>
                  </p>
                </div>`;
          footerSection = `
                <div class="quotation-footer">
                  <p>If you have any questions about this quotations, please contact<br>Nanda Febby Yuliantina, 082371425300, nandafebby@dinasti.id</p>
                </div>`;
        }

        loadLogoWithAuth(user.logo_url);

        const html = `
          <div class="flex justify-between items-start mb-6">
            <div class="shrink-0"><img id="logo_preview" class="h-40 w-40 object-contain" /></div>
            <div class="flex-1 px-4">
               <h1 class="font-bold text-red-600 text-lg leading-tight">${user.company}</h1>
               <p class="font-bold text-sm">${user.tagline}</p>
               <p class="text-xs leading-snug mt-1">${user.address}</p>
               <div class="text-xs mt-2 space-y-0.5">
                  <p class="font-medium">Social Media</p>
                  <p>Instagram : ${user.instagram}</p>
                  <p>Instagram : ${user.other_sosmed}</p>
               </div>
            </div>
            <div class="flex justify-end">
               <div class="text-right shrink-0">
                  <h2 class="font-bold text-xl text-indigo-400">QUOTATION</h2>
                  <table class="border-collapse text-xs mt-2">
                      <tr><td class="px-2 py-1 text-left">DATE</td><td class="border px-3 py-1 text-center">${data.tanggal_invoice}</td></tr>
                      <tr><td class="px-2 py-1 text-left">NO</td><td class="border px-3 py-1 text-center">${noValue}</td></tr>
                      <tr><td class="px-2 py-1 text-left">REV</td><td class="border px-3 py-1 text-center">${revisionInfo}</td></tr>
                  </table>
               </div>
            </div>
          </div>

          <div class="mb-4">
             <div class="bg-indigo-800 text-white font-bold text-xs px-2 py-1 inline-block">TO</div>
             <div class="text-sm mt-1 leading-snug">
                <p class="font-semibold">${data.pic_name}</p>
                <p class="font-semibold">${data.pelanggan_nama}</p>
                <p class="max-w-[500px] break-words">${data.alamat}</p>
                <hr class="my-2 border-t border-gray-300" />
                ${data.project_name ? `<p class="text-lg font-bold text-gray-800 mt-2">${data.project_name}</p>` : ""}
             </div>
          </div>

          <table class="w-full compact-table border-collapse border border-black mb-3">
             <thead class="bg-blue-900">
                <tr class="text-white">
                   <th class="text-center w-8 border border-black">No.</th>
                   <th colspan='2' class='text-center border border-black'>DESCRIPTION</th>
                   <th class="text-center w-12 border border-black">QTY</th>
                   <th class="text-center w-12 border border-black">UNIT</th>
                   <th class="text-center w-24 border border-black">UNIT PRICE</th>
                   <th class="text-center w-24 border border-black">TOTAL</th>
                </tr>
             </thead>
             <tbody>
                ${tableRows}
             </tbody>
          </table>

          <div class="flex justify-between items-start mt-6 text-xs">
             <div class="w-1/2 border">
                <div class="bg-gray-300 font-semibold px-3 py-1">Comments or Special Instructions</div>
                <div class="px-3 py-2 text-gray-700">
                   <p><span class="font-semibold">Terms of Payment :</span></p>
                   <p class="mb-2">${formatText(data.term_pembayaran)}</p>
                   
                   <p><span class="font-semibold">Terms and Conditions :</span></p>
                   <p class="mb-2">${formatText(data.syarat_ketentuan)}</p>
                   
                   <p><span class="font-semibold">Notes :</span></p>
                   <p>${formatText(data.catatan)}</p>
                </div>
             </div>
             <div class="w-1/3">
                <table class="text-xs w-full">
                   <tr><td class="pr-3 py-0.5 text-right font-semibold text-gray-700">SUBTOTAL</td><td class="py-0.5 text-gray-800"><div class="flex justify-between"><span>Rp</span><span>${finance(data.subtotal)}</span></div></td></tr>
                   <tr><td class="pr-3 py-0.5 text-right font-semibold text-gray-700">DISC</td><td class="py-0.5 text-gray-800">${data.disc ? `<div class="flex justify-between"><span>Rp</span><span>${finance(data.disc)}</span></div>` : "-"}</td></tr>
                   <tr><td class="pr-3 py-0.5 text-right font-semibold text-gray-700">PPN 11%</td><td class="py-0.5 text-gray-800"><div class="flex justify-between"><span>Rp</span><span>${finance(data.ppn)}</span></div></td></tr>
                   <tr class="font-bold border-t border-gray-300 total-row"><td class="pr-3 py-1 text-right text-gray-900">TOTAL</td><td class="py-1 text-blue-800 bg-blue-100"><div class="flex justify-between"><span>Rp</span><span>${finance(data.total)}</span></div></td></tr>
                </table>
             </div>
          </div>

          <div class="text-xs mb-3 border border-gray-400 p-2 text-center">
             <span class="font-semibold text-gray-700">Terbilang:</span>
             <span class="italic text-gray-800">${terbilang(data.total)} Rupiah</span>
          </div>

          ${signatureSection}
          ${approvedSection}
          ${footerSection}
        `;

        container.innerHTML = html;

        if (!isWon) {
          setTimeout(() => {
            const qrContainer = document.getElementById("qrcode");
            if (qrContainer) {
              new QRCode(qrContainer, {
                text: `https://digitalsign.dinastikelektrik.id/ref=${data.inv_number || data.no_qtn}`,
                width: 100, height: 100, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H
              });
              qrContainer.style.transform = "none";
              qrContainer.style.boxShadow = "2px 2px 6px rgba(0,0,0,0.2)";
            }
          }, 100);
        }

        if (isDownload) {
          setTimeout(() => {
            html2pdf().set({
              margin: 0,
              filename: `${noValue || "invoice"}.pdf`,
              image: { type: "jpeg", quality: 0.98 },
              html2canvas: { scale: 2 },
              jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
            }).from(container).save();
          }, 1000);
        }

      } catch (err) {
        console.error("Gagal memuat pesanan", err);
        alert("Gagal memuat data pesanan.");
      }
    }
    window.onload = loadPesananData;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</body>

</html>