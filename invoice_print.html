<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <title>Invoice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

    body {
      font-family: 'Roboto', sans-serif;
      background: #fff;
      font-size: 12px;
      position: relative;
      min-height: 297mm;
      /* Tinggi A4 */
    }

    .bordered th,
    .bordered td {
      border: 1px solid #e2e8f0;
      padding: 4px 6px;
    }

    .total-row {
      background-color: #f8fafc;
    }

    .compact-table {
      font-size: 11px;
    }

    .compact-table th,
    .compact-table td {
      padding: 3px 4px;
    }

    /* Footer khusus untuk quotation */
    .quotation-footer {
      position: absolute;
      bottom: 10mm;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 11px;
      padding-top: 10px;
      width: 210mm;
      margin: 0 auto;
    }

    /* Header new styling */
    .invoice-header {
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 8px;
      margin-bottom: 12px;
    }

    .company-name {
      color: #b91c1c;
      /* merah */
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .info-box {
      border: 1px solid #111827;
      padding: 6px 8px;
      width: 200px;
      text-align: left;
      font-size: 11px;
      background: #fff;
    }

    .table-solid th,
    .table-solid td {
      border: 1px solid #000 !important;
    }

    .table-solid thead {
      background: #1e3a8a;
      /* bg-blue-900 */
      color: #fff;
    }

    .money {
      text-align: right;
      white-space: nowrap;
    }

    @media print {
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
    }
  </style>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const script = document.createElement('script');
      script.src = `./assets/js/api.js?v=${new Date().getTime()}`;
      document.body.appendChild(script);
    });
  </script>
</head>

<body>
  <div id="invoiceContainer" class="w-[210mm] mx-auto p-[10mm] bg-white min-h-[277mm] relative pb-20"></div>

  <script>
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    const urlParams = new URLSearchParams(window.location.search);
    const pesanan_id = urlParams.get("id");
    const isDownload = urlParams.get("mode") === "download";
    const container = document.getElementById("invoiceContainer");

    const formatRp = val => `Rp ${(+val).toLocaleString("id-ID")}`;
    function finance(value) {
      return new Intl.NumberFormat("id-ID", {
        maximumFractionDigits: 0,
      }).format(value);
    }

    async function loadLogoWithAuth(url) {
      try {
        const res = await fetch(url, {
          headers: {
            "Authorization": `Bearer ${API_TOKEN}`
          }
        });
        if (!res.ok) throw new Error("Gagal load logo");

        const blob = await res.blob();
        const objectUrl = URL.createObjectURL(blob);

        const logoPreview = document.getElementById("logo_preview");
        logoPreview.src = objectUrl;
        logoPreview.classList.remove("hidden");
      } catch (err) {
        console.error("Error load logo:", err);
      }
    }

    function terbilang(n) {
      const satuan = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
      n = Math.floor(n);
      if (n < 12) return satuan[n];
      if (n < 20) return terbilang(n - 10) + " Belas";
      if (n < 100) return terbilang(Math.floor(n / 10)) + " Puluh " + terbilang(n % 10);
      if (n < 200) return "Seratus " + terbilang(n - 100);
      if (n < 1000) return terbilang(Math.floor(n / 100)) + " Ratus " + terbilang(n % 100);
      if (n < 2000) return "Seribu " + terbilang(n - 1000);
      if (n < 1000000) return terbilang(Math.floor(n / 1000)) + " Ribu " + terbilang(n % 1000);
      if (n < 1000000000) return terbilang(Math.floor(n / 1000000)) + " Juta " + terbilang(n % 1000000);
      return "";
    }

    function toRoman(num) {
      const romans = ["", "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X"];
      return romans[num] || num;
    }

    function toLetter(num) {
      return String.fromCharCode(64 + num); // 1 -> A, 2 -> B
    }

    async function loadFinanceAccount(ownerId) {
      try {
        const res = await fetch(`${baseUrl}/list/finance_account_payment/${ownerId}`, {
          headers: {
            Authorization: `Bearer ${API_TOKEN}`
          }
        });
        const result = await res.json();
        const list = result.listData || [];
        // ambil hanya akun dengan akun_id = 1
        const bca = list.find(acc => acc.akun_id == 1);
        return bca || null;
      } catch (err) {
        console.error("Gagal load rekening", err);
        return null;
      }
    }



    async function loadSubCategories() {
      try {
        const res = await fetch(`${baseUrl}/list/sub_category/1`, {
          headers: {
            Authorization: `Bearer ${API_TOKEN}`
          }
        });
        const result = await res.json();
        return result.listData || [];
      } catch (err) {
        console.error("Gagal memuat kategori", err);
        return [];
      }
    }

    async function loadPesananData() {
      try {
        const [subCategories, pesananRes, financeAccount] = await Promise.all([
          loadSubCategories(),
          fetch(`${baseUrl}/detail/sales_invoice/${pesanan_id}`, {
            headers: { Authorization: `Bearer ${API_TOKEN}` }
          }),
          loadFinanceAccount(user.owner_id)
        ]);



        const pesananResult = await pesananRes.json();
        const data = pesananResult?.detail;
        const salestype = data.type_id;
        console.log('Sales Type: ', salestype);
        if (!data) throw new Error("Data pesanan tidak ditemukan");

        const date = new Date(data.invoice_date_ymd);
        const bulanIndo = [
          "Januari", "Februari", "Maret", "April", "Mei", "Juni",
          "Juli", "Agustus", "September", "Oktober", "November", "Desember"
        ];
        const tanggal = date.getDate();
        const bulan = bulanIndo[date.getMonth()];
        const tahun = date.getFullYear();
        const tanggalFormatted = `${tanggal} ${bulan} ${tahun}`;

        // mapping sub_category name ke item
        const itemsWithCategory = data.items.map(item => {
          const category = subCategories.find(c => c.sub_category_id == item.sub_category_id);
          return {
            ...item,
            categoryName: category ? category.nama : 'Lainnya'
          };
        });

        // grouping by sub_category
        const groupedItems = itemsWithCategory.reduce((acc, item) => {
          if (!acc[item.categoryName]) acc[item.categoryName] = [];
          acc[item.categoryName].push(item);
          return acc;
        }, {});

        // build table (tetap pakai tableRows asli)
        const tableRows = Object.entries(groupedItems).map(([category, items]) => {
          let globalIndex = 1;
          return `
    <tr class="bg-white">
      <td colspan="7" class="p-1 font-bold bg-white text-black text-xs border border-black">
        ${category}
      </td>
    </tr>
    ${items.map(item => {
            let rowNumber = 1; // reset per item

            return `
        <tr class="bg-material">
          <td class="text-center text-gray-700 border border-black">${globalIndex++}</td>
          <td colspan="2" class="p-1 text-black border border-black">
            ${item.product || '-'}
            ${item.description ? `<div class="text-xs text-black">
            ${item.description && item.description.trim() !== "" && item.description !== "-"
                  ? item.description
                    .split(/\r?\n|-/) // pisahkan berdasarkan newline atau tanda '-'
                    .filter(line => line.trim() !== "") // buang yang kosong
                    .map(line => `<div class="mb-1">- ${line.trim()}</div>`) // jadikan div/paragraph
                    .join("")
                  : "-"
                } 
              </div>` : ''}
          </td>
          ${(item.materials && item.materials.length > 0)
                ? `<td colspan="4" class="text-center border border-black"></td>`
                : `
                <td class="text-center border border-black">${item.qty}</td>
                <td class="text-center border border-black">${item.unit}</td>
                <td class="border border-black">
                  <div class="flex justify-between">
                    <span>Rp</span>
                    <span>${finance(item.unit_price)}</span>
                  </div>
                </td>
                <td class="border border-black font-medium">
                  <div class="flex justify-between">
                    <span>Rp</span>
                    <span>${finance(item.total)}</span>
                  </div>
                </td>
              `
              }
        </tr>

        ${(item.materials || []).map(mat => `
            <tr>
              <td></td>
              <td class="border border-black">${rowNumber++}. ${mat.name}</td>
              <td class="border border-black">${mat.specification || '-'}</td>
              <td class="text-center border border-black">${mat.qty}</td>
              <td class="text-center border border-black">${mat.unit}</td>
                <td class="border border-black">
                  <div class="flex justify-between">
                    <span>Rp</span>
                    <span>${finance(mat.unit_price)}</span>
                  </div>
                </td>
                <td class="border border-black font-medium">
                  <div class="flex justify-between">
                    <span>Rp</span>
                    <span>${finance(mat.total)}</span>
                  </div>
                </td>
            </tr>
          `).join('')
              }
      `;
          }).join('')}
  `;
        }).join('');


        const isWon = data.status_id == 2 || data.status_sales === "Won";
        const headerTitle = isWon ? "INVOICE" : "QUOTATION";
        const detailTitle = isWon ? "Invoice" : "Quotation";
        const noLabel = isWon ? "No Invoice" : "No Qtn";

        let signatureSection = "";
        if (isWon) {
          signatureSection = `
        <div class="text-sm text-right">
          <p>Jakarta, ${data.formatted_date}</p>
          <div class="mt-2"></div>
          <p class="mt-2 font-semibold">${data.user_nama}</p>
          <p>${data.role}</p>
        </div>
      `;
        }

        // Footer khusus Quotation
        let footerSection = "";
        let approvedSection = "";

        function encodeSign(invNumber) {
          let base = btoa(invNumber); // ubah ke base64
          // ambil sebagian, ganti karakter biar kombinasi huruf+angka
          return base
            .replace(/=/g, "")      // hapus '='
            .replace(/\+/g, "X")    // ganti '+' biar aman
            .replace(/\//g, "9");   // ganti '/' jadi angka
        }
        if (!isWon) {
          signcode = 'https://digitalsign.dinastikelektrik.id/ref=', data.barcode;
          encodesign = encodeSign(signcode);
          approvedSection = `
          <div class="text-sm text-center mt-10">
            <!-- Tanggal -->
            <p class="font-semibold">Jakarta, ${tanggalFormatted}</p>

            <!-- QR Code -->
            <div id="qrcode" class="mt-2 inline-block p-2 bg-white rounded shadow"></div>

            <!-- Nama dan Role -->
            <p class="mt-2 font-semibold underline">${data.user_nama}</p>
            <p class="mt-2">${data.role}</p>
          </div>

        `;




          // generate QR
          setTimeout(() => {
            const qrContainer = document.getElementById("qrcode");
            if (qrContainer) {
              new QRCode(qrContainer, {
                text: `https://digitalsign.dinastikelektrik.id/ref=${data.inv_number}`,
                width: 100,
                height: 100,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
              });

              // style flat (tanpa miring)
              qrContainer.style.transform = "none";
              qrContainer.style.boxShadow = "2px 2px 6px rgba(0,0,0,0.2)";
            }
          }, 100);
        }




        loadLogoWithAuth(user.logo_url)
        const html = `
      <!-- Header -->
      <div class="invoice-header border-b-4 border-black pb-2">
  <div class="relative flex items-start justify-center">
    <!-- logo kiri -->
    <div class="absolute left-0 top-0">
      <img id="logo_preview" class="h-20 w-auto object-contain" alt="logo" />
    </div>

    <!-- teks tengah -->
    <div class="text-center">
      <div class="company-name text-2xl font-bold text-red-700">
        ${user.company || ''}
      </div>
      <div class="text-sm font-semibold mt-1 uppercase">
        ${user.tagline || ''}
      </div>
      <div class="text-xs mt-2 leading-tight">
        ${user.address || ''}
      </div>
      <div class="text-xs mt-1">
        ${user.phone ? 'Telp: ' + user.phone : ''} 
        ${user.email ? ' • ' + user.email : ''}
      </div>
    </div>
  </div>
</div>


      <div class="text-center underline font-bold text-xl mb-2 py-3">INVOICE</div>

<div class="flex justify-between items-start mt-4 mb-4 text-sm">

  <!-- Kiri: Kepada Yth -->
  <div class="w-1/2">
    <div class="mt-1 leading-snug">
      <p>Kepada Yth,</p>
      <p class="font-semibold">${data.pelanggan_nama || ''}</p>
      <p class="max-w-[500px] break-words">${data.alamat || ''}</p>
    </div>
  </div>

  <!-- Kanan: Detail Invoice -->
  <div class="w-1/2 flex justify-end">
    <table>
      <tr>
        <td class="px-2 font-medium">No</td>
        <td class="px-2 ">: ${data.inv_number || '-'}</td>
      </tr>
      <tr>
        <td class="px-2  font-medium">Tanggal</td>
        <td class="px-2 ">: ${data.invoice_date || '-'}</td>
      </tr>
      <tr>
        <td class="px-2  font-medium">No. PO</td>
        <td class="px-2 ">:  ${data.po_number || '-'}</td>
      </tr>
      <tr>
        <td class="px-2  font-medium">Tanggal PO</td>
        <td class="px-2 ">:  ${data.po_date || '-'}</td>
      </tr>
      
    </table>
  </div>

</div>


      <!-- Table Items -->
      <table class="w-full border border-black border-collapse table-auto text-xs text-black bg-white">
        <thead>
          <tr class="border-b border-black bg-white">
            <th class="text-center w-8 border border-black px-2 py-1">No.</th>
            ${salestype == 3
            ? `<th class="text-left border border-black px-2 py-1">DESCRIPTION</th>`
            : `<th colspan='2' class='text-left border border-black px-2 py-1'>DESCRIPTION</th>`}
            ${salestype == 3
            ? `<th class="text-left border border-black px-2 py-1">SPESIFICATION</th>`
            : ""}
            <th class="text-center w-12 border border-black px-2 py-1">QTY</th>
            <th class="text-center w-12 border border-black px-2 py-1">UNIT</th>
            <th class="text-center w-24 border border-black px-2 py-1">UNIT PRICE</th>
            <th class="text-center w-24 border border-black px-2 py-1">TOTAL</th>
          </tr>
        </thead>
        <tbody>
          ${tableRows}
        </tbody>
      </table>

      <div class="w-full flex justify-end">
  <div class="w-1/3">
    <table class="text-xs w-full border border-black border-collapse text-black bg-white">
      <tr class="border-b border-black">
        <td class="pr-3 py-0.5 text-right font-semibold border-r border-black">SUBTOTAL</td>
        <td class="py-0.5 text-right">Rp ${finance(data.subtotal)}</td>
      </tr>
      <tr class="border-b border-black">
        <td class="pr-3 py-0.5 text-right font-semibold border-r border-black">DISC</td>
        <td class="py-0.5 text-right">
          ${data.disc
            ? `<span>Rp ${finance(data.disc)}</span>`
            : "-"
          }
        </td>
      </tr>
      <tr class="border-b border-black">
        <td class="pr-3 py-0.5 text-right font-semibold border-r border-black">SHIPPING</td>
        <td class="py-0.5 text-right">
          ${data.shipping
            ? `<span>Rp ${finance(data.shipping)}</span>`
            : "-"
          }
        </td>
      </tr>
      <tr class="border-b border-black">
        <td class="pr-3 py-0.5 text-right font-semibold border-r border-black">PPN 11%</td>
        <td class="py-0.5 text-right">Rp ${finance(data.ppn)}</td>
      </tr>
      <tr class="font-bold border-t border-black bg-gray-300">
        <td class="pr-3 py-1 text-right border-r border-black">TOTAL</td>
        <td class="py-1 text-right">Rp ${finance(data.total)}</td>
      </tr>
    </table>
  </div>
</div>


      <div class="flex justify-between mt-10 text-xs">

    <!-- Kolom kiri: Terbilang + Pembayaran -->
    <div class="w-1/2">
      <!-- Terbilang -->
      <!-- Terbilang -->
      <div class="flex items-start text-sm mb-2 leading-relaxed">
        <span class="font-semibold w-20">Terbilang</span>
        <span class="mr-1">:</span>
        <p class="italic text-gray-800 flex-1 break-words">
          # ${terbilang(data.total)} Rupiah
        </p>
      </div>


      <!-- Pembayaran -->
      <div>
        <div class="font-semibold text-sm py-1">
          Pembayaran melalui:
        </div>
        <div class="py-2 text-sm text-gray-700">
          ${financeAccount
            ? `
                <strong>Bank :</strong> ${financeAccount.nama_akun}<br>
                <strong>Nama :</strong> ${financeAccount.owner_account}<br>
                <strong>A/C No :</strong> ${financeAccount.number_account}
              `
            : "-"
          }
        </div>
      </div>
    </div>

    <!-- Kolom kanan: Tanggal + Tanda tangan -->
    <div class="w-1/3 text-center flex flex-col items-center justify-center">
      <p class="font-semibold">Jakarta, ${tanggalFormatted}</p>

      <!-- QR Code -->
      <div id="qrcode-container" class="h-24 flex items-center justify-center mt-2">
        <div  class="inline-block p-2 bg-white rounded shadow"></div>
      </div>

      <p class="mt-2 font-semibold underline">${data.user_nama}</p>
      <p class="mt-2">${data.role}</p>
    </div>

  </div>

`;

        container.innerHTML = html;

        if (isDownload) {
          setTimeout(() => {
            html2pdf().set({
              margin: 0,
              filename: `${data.inv_number}.pdf`,
              image: { type: "jpeg", quality: 0.98 },
              html2canvas: { scale: 2 },
              jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
            }).from(container).save();
          }, 1000);
        }

      } catch (err) {
        console.error("Gagal memuat pesanan", err);
        alert("Gagal memuat data pesanan.");
      }
    }

    window.onload = loadPesananData;
  </script>
  <!-- load QRCode.js -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>


</body>

</html>