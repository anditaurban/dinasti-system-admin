<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <title>Receipt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

    body {
      font-family: 'Roboto', sans-serif;
      background: #fff;
      font-size: 12px;
      position: relative;
      min-height: 297mm;
      /* Tinggi A4 */
    }

    .bordered th,
    .bordered td {
      border: 1px solid #e2e8f0;
      padding: 4px 6px;
    }

    .total-row {
      background-color: #f8fafc;
    }

    .compact-table {
      font-size: 11px;
    }

    .compact-table th,
    .compact-table td {
      padding: 3px 4px;
    }

    /* Footer khusus untuk quotation */
    .quotation-footer {
      position: absolute;
      bottom: 10mm;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 11px;
      padding-top: 10px;
      width: 210mm;
      margin: 0 auto;
    }

    @media print {
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
    }
  </style>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const script = document.createElement('script');
      script.src = `./assets/js/api.js?v=${new Date().getTime()}`;
      document.body.appendChild(script);
    });
  </script>
</head>

<body>
  <div id="invoiceContainer" class="w-[210mm] mx-auto p-[10mm] bg-white min-h-[277mm] relative pb-20"></div>

  <script>
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    const urlParams = new URLSearchParams(window.location.search);
    const pesanan_id = urlParams.get("id");
    const isDownload = urlParams.get("mode") === "download";
    const container = document.getElementById("invoiceContainer");

    const formatRp = val => `Rp ${(+val).toLocaleString("id-ID")}`;
    function finance(value) {
      return new Intl.NumberFormat("id-ID", {
        maximumFractionDigits: 0,
      }).format(value);
    }

    async function loadLogoWithAuth(url) {
      try {
        const res = await fetch(url, {
          headers: {
            "Authorization": `Bearer ${API_TOKEN}`
          }
        });
        if (!res.ok) throw new Error("Gagal load logo");

        const blob = await res.blob();
        const objectUrl = URL.createObjectURL(blob);

        const logoPreview = document.getElementById("logo_preview");
        logoPreview.src = objectUrl;
        logoPreview.classList.remove("hidden");
      } catch (err) {
        console.error("Error load logo:", err);
      }
    }

    async function loadPesananData() {
      try {


        const pesananRes = await fetch(`${baseUrl}/detail/sales_receipt/${pesanan_id}`, {
          headers: { Authorization: `Bearer ${API_TOKEN}` }
        });
        const response = await pesananRes.json();
        const data = response.detail || {};
        console.log(response);

        // Load logo dengan token auth
        loadLogoWithAuth(user.logo_url);

        // Template HTML
        const html = `
  <!-- Header -->
  <div class="flex justify-between items-start mb-6">
    <!-- Logo -->
    <div class="shrink-0">
      <img id="logo_preview" class="h-40 w-40 object-contain" />
    </div>

    <!-- Company Info -->
    <div class="flex-1 px-4">
      <h1 class="font-bold text-red-600 text-lg leading-tight">
        ${user.company || "-"}
      </h1>
      <p class="font-bold text-sm">${user.tagline || ""}</p>
      <p class="text-xs leading-snug mt-1">
        ${user.address || ""}
      </p>
      <div class="text-xs mt-2 space-y-0.5">
        <p class="font-medium">Social Media</p>
        ${user.instagram ? `<p>Instagram: ${user.instagram}</p>` : ""}
        ${user.other_sosmed ? `<p>Instagram: ${user.other_sosmed}</p>` : ""}
      </div>
    </div>

    <!-- Document info Box -->
    <div class="flex justify-end">
      <div class="text-right shrink-0">
        <h2 class="font-bold text-xl text-indigo-400">KUITANSI</h2>
        <table class="border-collapse text-xs mt-2">
          <tr>
            <td class="px-2 py-1 text-left">Receipt</td>
            <td class="border px-3 py-1 text-center">${data.receipt_number || "-"}</td>
          </tr>
          <tr>
            <td class="px-2 py-1 text-left">Invoice</td>
            <td class="border px-3 py-1 text-center">${data.inv_number || "-"}</td>
          </tr>
          <tr>
            <td class="px-2 py-1 text-left">Ref</td>
            <td class="border px-3 py-1 text-center">${data.ref || "-"}</td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <!-- Body -->
  <div class="space-y-4 text-sm">
    <div class="flex">
      <div class="w-1/4 font-bold">Terima Dari</div>
      <div class="flex-1">${data.pelanggan_nama || "-"}</div>
    </div>

    <div class="flex">
      <div class="w-1/4 font-bold">Banyaknya Uang</div>
      <div class="flex-1 bg-gray-50 border px-3 py-2 italic">
        ${data.terbilang || "-"}
      </div>
    </div>

    <div class="flex items-start">
      <div class="w-1/4 font-bold">Keterangan</div>
      <div class="flex-1 bg-gray-50 border px-3 py-6 italic">
        ${data.keterangan || "-"}
      </div>
    </div>
  </div>

  <hr class="my-4"/>

  <!-- Footer -->
  <div class="flex justify-between items-start">
    <div class="font-bold text-lg flex items-center">
      Jumlah 
      <span id="nominal" class="text-xl bg-gray-50 border px-3 py-2 ml-2">
        Rp ${finance(data.nominal) || "0"}
      </span>
    </div>
    <div class="text-right">
      <p id="tanggal">${data.tanggal || "-"}</p>
      <p class="font-bold mt-1">${user.company || "-"}</p>
    </div>
  </div>
`;

        container.innerHTML = html;

        // Export ke PDF jika diminta
        if (isDownload) {
          setTimeout(() => {
            html2pdf().set({
              margin: 0,
              filename: `${data.receipt_number || "document"}.pdf`,
              image: { type: "jpeg", quality: 0.98 },
              html2canvas: { scale: 2 },
              jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
            }).from(container).save();
          }, 1000);
        }
      } catch (err) {
        console.error("Gagal memuat pesanan", err);
        alert("Gagal memuat data pesanan.");
      }
    }


    window.onload = loadPesananData;
  </script>
  <!-- load QRCode.js -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>


</body>

</html>