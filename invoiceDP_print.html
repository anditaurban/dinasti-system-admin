<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <title>Invoice DP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

    body {
      font-family: 'Roboto', sans-serif;
      background: #fff;
      font-size: 12px;
      position: relative;
      min-height: 297mm;
      /* Tinggi A4 */
    }

    .bordered th,
    .bordered td {
      border: 1px solid #e2e8f0;
      padding: 4px 6px;
    }

    .total-row {
      background-color: #f8fafc;
    }

    .compact-table {
      font-size: 11px;
    }

    .compact-table th,
    .compact-table td {
      padding: 3px 4px;
    }

    /* Footer khusus untuk quotation */
    .quotation-footer {
      position: absolute;
      bottom: 10mm;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 11px;
      padding-top: 10px;
      width: 210mm;
      margin: 0 auto;
    }

    /* == STYLE BARU DARI FILE KEDUA == */
    .invoice-header {
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 8px;
      margin-bottom: 12px;
    }

    .company-name {
      color: #b91c1c;
      /* merah */
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .info-box {
      border: 1px solid #111827;
      padding: 6px 8px;
      width: 200px;
      text-align: left;
      font-size: 11px;
      background: #fff;
    }

    .table-solid th,
    .table-solid td {
      border: 1px solid #000 !important;
    }

    .table-solid thead {
      background: #1e3a8a;
      /* bg-blue-900 */
      color: #fff;
    }

    .money {
      text-align: right;
      white-space: nowrap;
    }

    /* == AKHIR STYLE BARU == */


    @media print {
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
    }
  </style>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const script = document.createElement('script');
      script.src = `./assets/js/api.js?v=${new Date().getTime()}`;
      document.body.appendChild(script);
    });
  </script>
</head>

<body>
  <div id="invoiceContainer" class="w-[210mm] mx-auto p-[10mm] bg-white min-h-[277mm] relative pb-20"></div>

  <script>
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    const urlParams = new URLSearchParams(window.location.search);
    const pesanan_id = urlParams.get("id");
    const isDownload = urlParams.get("mode") === "download";
    const container = document.getElementById("invoiceContainer");

    const formatRp = val => `Rp ${(+val).toLocaleString("id-ID")}`;
    function finance(value) {
      return new Intl.NumberFormat("id-ID", {
        maximumFractionDigits: 0,
      }).format(value);
    }

    async function loadLogoWithAuth(url) {
      try {
        const res = await fetch(url, {
          headers: {
            "Authorization": `Bearer ${API_TOKEN}`
          }
        });
        if (!res.ok) throw new Error("Gagal load logo");

        const blob = await res.blob();
        const objectUrl = URL.createObjectURL(blob);

        const logoPreview = document.getElementById("logo_preview");
        logoPreview.src = objectUrl;
        logoPreview.classList.remove("hidden");
      } catch (err) {
        console.error("Error load logo:", err);
      }
    }

    function terbilang(n) {
      const satuan = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
      n = Math.floor(n);
      if (n < 12) return satuan[n];
      if (n < 20) return terbilang(n - 10) + " Belas";
      if (n < 100) return terbilang(Math.floor(n / 10)) + " Puluh " + terbilang(n % 10);
      if (n < 200) return "Seratus " + terbilang(n - 100);
      if (n < 1000) return terbilang(Math.floor(n / 100)) + " Ratus " + terbilang(n % 100);
      if (n < 2000) return "Seribu " + terbilang(n - 1000);
      if (n < 1000000) return terbilang(Math.floor(n / 1000)) + " Ribu " + terbilang(n % 1000);
      if (n < 1000000000) return terbilang(Math.floor(n / 1000000)) + " Juta " + terbilang(n % 1000000);
      return "";
    }

    function toRoman(num) {
      const romans = ["", "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X"];
      return romans[num] || num;
    }

    function toLetter(num) {
      return String.fromCharCode(64 + num); // 1 -> A, 2 -> B
    }

    // Fungsi baru dari file kedua
    async function loadFinanceAccount(ownerId) {
      try {
        const res = await fetch(`${baseUrl}/list/finance_account_payment/${ownerId}`, {
          headers: {
            Authorization: `Bearer ${API_TOKEN}`
          }
        });
        const result = await res.json();
        const list = result.listData || [];
        // ambil hanya akun dengan akun_id = 1
        const bca = list.find(acc => acc.akun_id == 1);
        return bca || null;
      } catch (err) {
        console.error("Gagal load rekening", err);
        return null;
      }
    }

    async function loadSubCategories() {
      // Fungsi ini tidak terpakai di DP, tapi dibiarkan
      try {
        const res = await fetch(`${baseUrl}/list/sub_category/1`, {
          headers: {
            Authorization: `Bearer ${API_TOKEN}`
          }
        });
        const result = await res.json();
        return result.listData || [];
      } catch (err) {
        console.error("Gagal memuat kategori", err);
        return [];
      }
    }

    async function loadPesananData() {
      try {
        // Modifikasi Promise.all untuk memuat financeAccount
        const [pesananRes, financeAccount] = await Promise.all([
          fetch(`${baseUrl}/detail/sales_dp/${pesanan_id}`, {
            headers: { Authorization: `Bearer ${API_TOKEN}` }
          }),
          loadFinanceAccount(user.owner_id) // Ditambahkan
        ]);

        const pesananResult = await pesananRes.json();
        const data = pesananResult?.detail;
        if (!data) throw new Error("Data pesanan DP tidak ditemukan");

        const today = new Date();
        const options = {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        };
        const tanggalFormatted = today.toLocaleDateString('id-ID', options);

        loadLogoWithAuth(user.logo_url)

        // HTML DI BAWAH INI ADALAH GABUNGAN STYLE DARI FILE 2
        // (HEADER, INFO BANK, TTD) DENGAN TABEL ASLI DARI FILE 1
        const html = `
        <div class="invoice-header border-b-4 border-black pb-2">
          <div class="relative flex items-start justify-center">
            <div class="absolute left-0 top-0">
              <img id="logo_preview" class="h-20 w-auto object-contain" alt="logo" />
            </div>

            <div class="text-center">
              <div class="company-name text-2xl font-bold text-red-700">
                ${user.company || ''}
              </div>
              <div class="text-sm font-semibold mt-1 uppercase">
                ${user.tagline || ''}
              </div>
              <div class="text-xs mt-2 leading-tight">
                ${user.address || ''}
              </div>
              <div class="text-xs mt-1">
                ${user.company_phone ? 'Telp: ' + user.company_phone : ''} 
                ${user.company_email ? ' â€¢ ' + user.company_email : ''}
              </div>
            </div>
          </div>
        </div>

        <div class="text-center underline font-bold text-xl mb-2 py-3">PROFORMA INVOICE</div>

        <div class="flex justify-between items-start mt-4 mb-4 text-sm">

          <div class="w-1/2">
            <div class="mt-1 leading-snug">
              <p>Kepada Yth,</p>
              <p class="font-semibold">${data.pelanggan_nama || ''}</p>
              ${data.pic_client ? `<p>Up. ${data.pic_client}</p>` : ''}
              <p class="max-w-[500px] break-words">${data.alamat || ''}</p>
              ${data.project_name
            ? `<p class="text-base font-bold text-gray-800 mt-2">${data.project_name}</p>`
            : ""}
            </div>
          </div>

          <div class="w-1/2 flex justify-end">
            <table>
              <tr>
                <td class="px-2 font-medium">No</td>
                <td class="px-2 ">: ${data.dp_number || '-'}</td>
              </tr>
              <tr>
                <td class="px-2 font-medium">Tanggal</td>
                <td class="px-2 ">: ${tanggalFormatted}</td>
              </tr>
              <tr>
                <td class="px-2 font-medium">Ref. Invoice</td>
                <td class="px-2 ">: ${data.inv_number || '-'}</td>
              </tr>
            </table>
          </div>
        </div>


        <table class="w-full border-collapse text-sm">
          <thead>
            <tr class="bg-gray-800 text-white">
              <th class="text-left px-4 py-2">Deskripsi</th>
              <th class="text-right px-4 py-2">Invoice Uang Muka</th>
            </tr>
          </thead>
          <tbody>
            <tr class="bg-gray-50">
              <td class="px-4 py-2 align-top">
                ${data.description}
              </td>
              <td class="px-4 py-2 text-right align-top">
                <div>${finance(data.amount)}</div>
                <div class="text-xs text-gray-600">(${data.percentage} Dari total tagihan)</div>
              </td>
            </tr>
            <tr class="bg-gray-50 border-t">
              <td colspan="2" class="px-4 py-2 text-sm">
                <span class="font-semibold">Referensi Dokumen:</span>
                ${data.inv_number} - ${finance(data.contract_amount)}
              </td>
            </tr>
          </tbody>
        </table>

        <div class="flex justify-between items-start mt-6 text-xs">
          <div>
            </div>

          <div class="w-1/3">
            <table class="text-xs w-full">
              <tr class="font-bold border-t border-gray-300 total-row">
                <td class="pr-3 py-1 text-right text-gray-900">TOTAL</td>
                <td class="py-1 text-blue-800 bg-blue-100">
                  <div class="flex justify-between">
                    <span>Rp</span>
                    <span>${finance(data.amount)}</span>
                  </div>
                </td>
              </tr>
            </table>
          </div>
        </div>
        <div class="flex justify-between mt-10 text-xs">

          <div class="w-1/2">
            <div class="flex items-start text-sm mb-2 leading-relaxed">
              <span class="font-semibold w-20">Terbilang</span>
              <span class="mr-1">:</span>
              <p class="italic text-gray-800 flex-1 break-words">
                # ${terbilang(data.amount)} Rupiah
              </p>
            </div>

            <div>
              <div class="font-semibold text-sm py-1">
                Pembayaran melalui:
              </div>
              <div class="py-2 text-sm text-gray-700">
                ${financeAccount
            ? `
                      <strong>Bank :</strong> ${financeAccount.nama_akun}<br>
                      <strong>Nama :</strong> ${financeAccount.owner_account}<br>
                      <strong>A/C No :</strong> ${financeAccount.number_account}
                    `
            : "<em>Informasi rekening tidak tersedia</em>"
          }
              </div>
            </div>
          </div>

          <div class="w-1/3 text-center flex flex-col items-center justify-center ml-auto"> <p class="font-semibold">Jakarta, ${tanggalFormatted}</p>

            <div id="qrcode-container" class="h-24 flex items-center justify-center mt-2">
              <div class="inline-block p-2 bg-white rounded shadow"></div>
            </div>

            <p class="mt-2 font-semibold underline">Nanda Febby Yuliantina</p>
            <p class="mt-2">Finance Manager</p>
          </div>

        </div>
        `;

        container.innerHTML = html;

        if (isDownload) {
          setTimeout(() => {
            html2pdf().set({
              margin: 0,
              filename: `${data.dp_number || 'proforma'}.pdf`, // Ubah nama file
              image: { type: "jpeg", quality: 0.98 },
              html2canvas: { scale: 2 },
              jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
            }).from(container).save();
          }, 1000);
        }

      } catch (err) {
        console.error("Gagal memuat pesanan", err);
        alert("Gagal memuat data pesanan.");
      }
    }

    window.onload = loadPesananData;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>


</body>

</html>