<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <title>Invoice DP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

    body {
      font-family: 'Roboto', sans-serif;
      background: #fff;
      font-size: 12px;
      position: relative;
      min-height: 297mm;
      /* Tinggi A4 */
    }

    .bordered th,
    .bordered td {
      border: 1px solid #e2e8f0;
      padding: 4px 6px;
    }

    .total-row {
      background-color: #f8fafc;
    }

    .compact-table {
      font-size: 11px;
    }

    .compact-table th,
    .compact-table td {
      padding: 3px 4px;
    }

    /* Footer khusus untuk quotation */
    .quotation-footer {
      position: absolute;
      bottom: 10mm;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 11px;
      padding-top: 10px;
      width: 210mm;
      margin: 0 auto;
    }

    @media print {
  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
}


  </style>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const script = document.createElement('script');
      script.src = `./assets/js/api.js?v=${new Date().getTime()}`;
      document.body.appendChild(script);
    });
  </script>
</head>

<body>
  <div id="invoiceContainer" class="w-[210mm] mx-auto p-[10mm] bg-white min-h-[277mm] relative pb-20"></div>

  <script>
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    const urlParams = new URLSearchParams(window.location.search);
    const pesanan_id = urlParams.get("id");
    const isDownload = urlParams.get("mode") === "download";
    const container = document.getElementById("invoiceContainer");

    const formatRp = val => `Rp ${(+val).toLocaleString("id-ID")}`;
    function finance(value) {
  return new Intl.NumberFormat("id-ID", {
    maximumFractionDigits: 0,
  }).format(value);
}

async function loadLogoWithAuth(url) {
  try {
    const res = await fetch(url, {
      headers: {
        "Authorization": `Bearer ${API_TOKEN}`
      }
    });
    if (!res.ok) throw new Error("Gagal load logo");

    const blob = await res.blob();
    const objectUrl = URL.createObjectURL(blob);

    const logoPreview = document.getElementById("logo_preview");
    logoPreview.src = objectUrl;
    logoPreview.classList.remove("hidden");
  } catch (err) {
    console.error("Error load logo:", err);
  }
}

    function terbilang(n) {
      const satuan = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
      n = Math.floor(n);
      if (n < 12) return satuan[n];
      if (n < 20) return terbilang(n - 10) + " Belas";
      if (n < 100) return terbilang(Math.floor(n / 10)) + " Puluh " + terbilang(n % 10);
      if (n < 200) return "Seratus " + terbilang(n - 100);
      if (n < 1000) return terbilang(Math.floor(n / 100)) + " Ratus " + terbilang(n % 100);
      if (n < 2000) return "Seribu " + terbilang(n - 1000);
      if (n < 1000000) return terbilang(Math.floor(n / 1000)) + " Ribu " + terbilang(n % 1000);
      if (n < 1000000000) return terbilang(Math.floor(n / 1000000)) + " Juta " + terbilang(n % 1000000);
      return "";
    }

    function toRoman(num) {
      const romans = ["", "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X"];
      return romans[num] || num;
    }

    function toLetter(num) {
      return String.fromCharCode(64 + num); // 1 -> A, 2 -> B
    }

    async function loadSubCategories() {
      try {
        const res = await fetch(`${baseUrl}/list/sub_category/1`, {
          headers: {
            Authorization: `Bearer ${API_TOKEN}`
          }
        });
        const result = await res.json();
        return result.listData || [];
      } catch (err) {
        console.error("Gagal memuat kategori", err);
        return [];
      }
    }

    async function loadPesananData() {
      try {
        const [subCategories, pesananRes] = await Promise.all([
          loadSubCategories(),
          fetch(`${baseUrl}/detail/sales_dp/${pesanan_id}`, {
            headers: { Authorization: `Bearer ${API_TOKEN}` }
          })
        ]);

        

        const pesananResult = await pesananRes.json();
        const data = pesananResult?.detail;
 
loadLogoWithAuth(user.logo_url)
const html = `
  <!-- Header -->
  <div class="flex justify-between items-start mb-6">
    <!-- Logo -->
    <div class="shrink-0">
      <img id="logo_preview" class="h-40 w-40 object-contain" />
    </div>

    <!-- Company Info -->
    <div class="flex-1 px-4">
      <h1 class="font-bold text-red-600 text-lg leading-tight">
        ${user.company || "-"}
      </h1>
      <p class="font-bold text-sm">${user.tagline || ""}</p>
      <p class="text-xs leading-snug mt-1">
        ${user.address || ""}
      </p>
      <div class="text-xs mt-2 space-y-0.5">
        <p class="font-medium">Social Media</p>
        ${user.instagram ? `<p>Instagram: ${user.instagram}</p>` : ""}
        ${user.other_sosmed ? `<p>Instagram: ${user.other_sosmed}</p>` : ""}
      </div>
    </div>

    <!-- Document info Box -->
    <div class="flex justify-end">
      <div class="text-right shrink-0">
        <h2 class="font-bold text-xl text-indigo-400">PROFORMA INVOICE</h2>
        <table class="border-collapse text-xs mt-2">
          <tr>
            <td class="px-2 py-1 text-left">Document</td>
            <td class="border px-3 py-1 text-center">${data.dp_number || "-"}</td>
          </tr>
          <tr>
            <td class="px-2 py-1 text-left">Invoice</td>
            <td class="border px-3 py-1 text-center">${data.inv_number || "-"}</td>
          </tr>
          <tr>
            <td class="px-2 py-1 text-left">Ref</td>
            <td class="border px-3 py-1 text-center">${data.inv_number || "-"}</td>
          </tr>
        </table>
      </div>
    </div>
</div>
  <!-- Recipient Info -->
<div class="mb-4">
  <div class="bg-indigo-800 text-white font-bold text-xs px-2 py-1 inline-block">
    TO
  </div>
<div class="text-sm mt-1 leading-snug">
  <p class="font-semibold">${data.pic_client}</p>
  <p class="font-semibold">${data.pelanggan_nama}</p>
  <p class="max-w-[500px] break-words">${data.alamat}</p>

  <hr class="my-2 border-t border-gray-300" />

  ${data.project_name 
    ? `<p class="text-lg font-bold text-gray-800 mt-2">${data.project_name}</p>` 
    : ""}
</div>

</div>

<table class="w-full border-collapse text-sm">
  <thead>
    <tr class="bg-gray-800 text-white">
      <th class="text-left px-4 py-2">Deskripsi</th>
      <th class="text-right px-4 py-2">Invoice Uang Muka</th>
    </tr>
  </thead>
  <tbody>
    <tr class="bg-gray-50">
      <td class="px-4 py-2 align-top">
        ${data.description}
      </td>
      <td class="px-4 py-2 text-right align-top">
        <div>${finance(data.amount)}</div>
        <div class="text-xs text-gray-600">(${data.percentage} Dari total tagihan)</div>
      </td>
    </tr>
    <tr class="bg-gray-50 border-t">
      <td colspan="2" class="px-4 py-2 text-sm">
        <span class="font-semibold">Referensi Dokumen:</span>
        ${data.inv_number} - ${finance(data.contract_amount)}
      </td>
    </tr>
  </tbody>
</table>



<div class="flex justify-between items-start mt-6 text-xs">
  <!-- Comments / Special Instructions -->
  <div>
    <!-- Header abu-abu -->


    <!-- Isi -->

  </div>

  <!-- Totals -->
  <div class="w-1/3">
<table class="text-xs w-full">
  <tr class="font-bold border-t border-gray-300 total-row">
    <td class="pr-3 py-1 text-right text-gray-900">TOTAL</td>
    <td class="py-1 text-blue-800 bg-blue-100">
      <div class="flex justify-between">
        <span>Rp</span>
        <span>${finance(data.amount)}</span>
      </div>
    </td>
  </tr>
</table>

  </div>
</div>
<br><br><br>

        <div class="w-1/3 text-center flex flex-col items-center justify-center">
      <p class="font-semibold">Jakarta, ${tanggalFormatted}</p>

      <!-- QR Code -->
      <div id="qrcode-container" class="h-24 flex items-center justify-center mt-2">
        <div  class="inline-block p-2 bg-white rounded shadow"></div>
      </div>

      <p class="mt-2 font-semibold underline">Nanda Febby Yuliantina</p>
      <p class="mt-2">Finance Manager</p>
    </div>
  

`;

        container.innerHTML = html;

        if (isDownload) {
          setTimeout(() => {
            html2pdf().set({
              margin: 0,
              filename: `${data.inv_number}.pdf`,
              image: { type: "jpeg", quality: 0.98 },
              html2canvas: { scale: 2 },
              jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
            }).from(container).save();
          }, 1000);
        }

      } catch (err) {
        console.error("Gagal memuat pesanan", err);
        alert("Gagal memuat data pesanan.");
      }
    }

    window.onload = loadPesananData;
  </script>
  <!-- load QRCode.js -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>


</body>

</html>